#!/usr/bin/env bash
#
# Agentic Mobile App Builder - Main Entry Point
# Multi-agent orchestration framework for mobile app development
#
# IMPORTANT: When adding commands, update BOTH this file AND src/cli/index.ts
#

set -e

# Script directory
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m' # No Color

# Print colored message
print_color() {
    local color="$1"
    shift
    echo -e "${color}$*${NC}"
}

# Run CLI via tsx
run_cli() {
    npx tsx "$SCRIPT_DIR/src/cli/index.ts" "$@"
}

# Show banner
show_banner() {
    echo ""
    print_color "$CYAN" "╔═══════════════════════════════════════════════════════════╗"
    print_color "$CYAN" "║         Agentic Mobile App Builder v1.0.0                 ║"
    print_color "$CYAN" "║   Multi-Agent Orchestration for Mobile App Development   ║"
    print_color "$CYAN" "╚═══════════════════════════════════════════════════════════╝"
    echo ""
}

# Show help
show_help() {
    show_banner
    print_color "$GREEN" "Usage: agentic-builder <command> [options]"
    echo ""
    print_color "$YELLOW" "Quick Start Commands:"
    echo "  create-app <name>         Create a new mobile app from scratch"
    echo "  add-feature <name>        Add a new feature to existing app"
    echo "  fix-bug <description>     Fix a bug in the application"
    echo "  refactor                  Refactor and improve code quality"
    echo ""
    print_color "$YELLOW" "Workflow Commands:"
    echo "  run <workflow>            Run a specific workflow"
    echo "  workflows                 List available workflows"
    echo "  agents                    List available agents"
    echo ""
    print_color "$YELLOW" "Session Management:"
    echo "  list                      List workflow sessions"
    echo "  status <id>               Show session status"
    echo "  resume <id>               Resume from checkpoint"
    echo "  cancel <id>               Cancel running workflow"
    echo "  logs <id>                 View session logs"
    echo ""
    print_color "$YELLOW" "Utilities:"
    echo "  usage                     Show token usage statistics"
    echo "  clean                     Clean up old sessions"
    echo ""
    print_color "$YELLOW" "Options:"
    echo "  -h, --help                Show this help message"
    echo "  -v, --version             Show version"
    echo ""
    print_color "$CYAN" "Examples:"
    echo "  agentic-builder create-app MyApp"
    echo "  agentic-builder run FULL_APP_GENERATION -p MyApp"
    echo "  agentic-builder add-feature \"user authentication\""
    echo "  agentic-builder status abc-123-def"
    echo "  agentic-builder resume abc-123-def"
    echo ""
}

# Quick start: Create new app
create_app() {
    local name="${1:-my-app}"
    print_color "$GREEN" "Creating new mobile app: $name"
    run_cli run FULL_APP_GENERATION --project "$name" "${@:2}"
}

# Quick start: Add feature
add_feature() {
    local feature="$1"
    if [ -z "$feature" ]; then
        print_color "$RED" "Error: Please specify a feature name/description"
        echo "Usage: agentic-builder add-feature <feature-description>"
        exit 1
    fi
    print_color "$GREEN" "Adding feature: $feature"
    run_cli run FEATURE_ADDITION --description "$feature" "${@:2}"
}

# Quick start: Fix bug
fix_bug() {
    local bug="$1"
    if [ -z "$bug" ]; then
        print_color "$RED" "Error: Please specify a bug description"
        echo "Usage: agentic-builder fix-bug <bug-description>"
        exit 1
    fi
    print_color "$GREEN" "Fixing bug: $bug"
    run_cli run BUG_FIX --description "$bug" "${@:2}"
}

# Quick start: Refactor
refactor() {
    print_color "$GREEN" "Starting code refactoring..."
    run_cli run REFACTORING "$@"
}

# Quick start: Run tests
run_tests() {
    print_color "$GREEN" "Generating tests..."
    run_cli run TEST_GENERATION "$@"
}

# Quick start: Code review
code_review() {
    print_color "$GREEN" "Running code review..."
    run_cli run CODE_REVIEW "$@"
}

# Quick start: Security audit
security_audit() {
    print_color "$GREEN" "Running security audit..."
    run_cli run SECURITY_AUDIT "$@"
}

# Check dependencies
check_deps() {
    local missing=0

    if ! command -v node &> /dev/null; then
        print_color "$RED" "Error: Node.js is not installed"
        missing=1
    fi

    if ! command -v npx &> /dev/null; then
        print_color "$RED" "Error: npx is not available"
        missing=1
    fi

    if ! command -v claude &> /dev/null; then
        print_color "$YELLOW" "Warning: Claude CLI is not installed or not in PATH"
        echo "Some features may not work. Install from: https://claude.ai/cli"
    fi

    if ! command -v git &> /dev/null; then
        print_color "$YELLOW" "Warning: Git is not installed"
        echo "Git integration features will not work."
    fi

    if [ $missing -eq 1 ]; then
        exit 1
    fi
}

# Install dependencies if needed
install_deps() {
    if [ ! -d "$SCRIPT_DIR/node_modules" ]; then
        print_color "$YELLOW" "Installing dependencies..."
        cd "$SCRIPT_DIR" && npm install
    fi
}

# Main entry point
main() {
    # Handle help and version flags
    case "${1:-}" in
        -h|--help|help)
            show_help
            exit 0
            ;;
        -v|--version|version)
            echo "agentic-builder v1.0.0"
            exit 0
            ;;
    esac

    # Check dependencies
    check_deps

    # Install npm dependencies if needed
    install_deps

    # Route commands
    case "${1:-}" in
        # Quick start commands
        create-app)
            shift
            create_app "$@"
            ;;
        add-feature)
            shift
            add_feature "$@"
            ;;
        fix-bug)
            shift
            fix_bug "$@"
            ;;
        refactor)
            shift
            refactor "$@"
            ;;
        test|run-tests)
            shift
            run_tests "$@"
            ;;
        review|code-review)
            shift
            code_review "$@"
            ;;
        security|security-audit)
            shift
            security_audit "$@"
            ;;

        # Pass through to CLI
        run|workflows|agents|list|status|resume|cancel|logs|usage|clean)
            run_cli "$@"
            ;;

        # No command - show help
        "")
            show_help
            exit 0
            ;;

        # Unknown command - try passing to CLI
        *)
            run_cli "$@"
            ;;
    esac
}

# Run main
main "$@"
